warning = function() end

local PANEL_NAME = "protectLnsCustomV1"

local GOOGLE_SHEETS_BASE =
  "https://docs.google.com/spreadsheets/d/1gpxKsTa_8LQ-ADSC9NGaruQJUvNhVv3Io7fE-RLnkqw/gviz/tq?tqx=out:json"

local START_DELAY_MS = 1000
local FAILSAFE_REVOKE_ON_ERROR = true

local TARGET_NAME   = "Lns Custom v2"
local BASE_DIR      = "/bot/" .. TARGET_NAME
local INSTALLED_TAG = BASE_DIR .. "/.installed"

if g_resources and (
    (g_resources.fileExists and g_resources.fileExists(INSTALLED_TAG)) or
    (g_resources.directoryExists and g_resources.directoryExists(BASE_DIR))
) then
  return
end

storage[PANEL_NAME] = storage[PANEL_NAME] or { last = 0, authorized = false }

-- ==========================================================
-- Utils
-- ==========================================================
local function trim(s)
  return (tostring(s or ""):gsub("^%s+", ""):gsub("%s+$", ""))
end

local function normalizeMAC(mac)
  mac = tostring(mac or ""):upper()
  mac = mac:gsub("[%s:]", ""):gsub("%-", "")
  if #mac >= 12 then mac = mac:sub(1, 12) end
  if #mac ~= 12 then return "" end
  if not mac:match("^[0-9A-F]+$") then return "" end
  if mac == "000000000000" then return "" end
  return mac
end

local function isMobile()
  if modules and modules._G and modules._G.g_app and type(modules._G.g_app.isMobile) == "function" then
    local ok, r = pcall(function() return modules._G.g_app.isMobile() end)
    if ok then return r == true end
  end
  return false
end

local function schedule(ms, fn)
  if type(scheduleEvent) == "function" then
    return scheduleEvent(fn, ms)
  end
  if g_dispatcher and type(g_dispatcher.scheduleEvent) == "function" then
    return g_dispatcher:scheduleEvent(fn, ms)
  end
  return fn()
end

-- HTTP wrapper (prefer corelib)
local function httpGet(url, cb)
  if modules and modules.corelib and modules.corelib.HTTP and type(modules.corelib.HTTP.get) == "function" then
    return modules.corelib.HTTP.get(url, cb)
  end
  local HTTP = modules and modules._G and modules._G.HTTP
  if HTTP and type(HTTP.get) == "function" then
    return HTTP.get(url, cb)
  end
  return cb(nil, "HTTP.get nao disponivel")
end

local function getUUID()
  if not modules._G or not modules._G.g_crypt or not modules._G.g_crypt.getMachineUUID then
    return ""
  end
  return trim(modules._G.g_crypt.getMachineUUID())
end

local function getAllMACs()
  local out = {}
  if not modules.client or not modules.client.g_platform or not modules.client.g_platform.getMacAddresses then
    return out
  end
  local ok, list = pcall(function()
    return modules.client.g_platform.getMacAddresses()
  end)
  if not ok or type(list) ~= "table" then
    return out
  end
  local seen = {}
  for i = 1, #list do
    local n = normalizeMAC(list[i])
    if n ~= "" and not seen[n] then
      seen[n] = true
      out[#out + 1] = n
    end
  end
  return out
end

local function cleanGVizResponse(resp)
  resp = tostring(resp or "")
  resp = resp:gsub("^%s*/%*O_o%*/%s*", "")
  resp = resp:gsub("^%s*google%.visualization%.Query%.setResponse%(", "")
  resp = resp:gsub("%)%s*;%s*$", "")
  return resp
end

local function getCellValue(row, idx)
  if not row or not row.c then return nil end
  local cell = row.c[idx]
  if not cell then return nil end
  if cell.v ~= nil then return cell.v end
  return nil
end

local function joinLines(t)
  local out = {}
  for i = 1, #t do out[#out+1] = tostring(t[i]) end
  return table.concat(out, "\n")
end

-- ==========================================================
-- Authorization
-- ==========================================================
local function checkAuthorization(onDone)
  local uuid = getUUID()
  local macs = getAllMACs()
  local mobile = isMobile()

  if mobile then
    if uuid == "" then
      if onDone then onDone(false, "") end
      return
    end
  else
    if uuid == "" or #macs == 0 then
      if onDone then onDone(false, "") end
      return
    end
  end

  local cb = tostring(now or os.time())
  local url = GOOGLE_SHEETS_BASE .. "&cb=" .. cb

  httpGet(url, function(resp, err)
    if err or not resp then
      if FAILSAFE_REVOKE_ON_ERROR then
        if onDone then onDone(false, "") end
      else
        if onDone then onDone(true, "") end
      end
      return
    end

    local clean = cleanGVizResponse(resp)
    local ok, data = pcall(function() return json.decode(clean) end)
    if not ok or not data or not data.table or type(data.table.rows) ~= "table" then
      if onDone then onDone(false, "") end
      return
    end

    local rows = data.table.rows
    for _, row in ipairs(rows) do
      local sheetUUID = trim(getCellValue(row, 1))
      local sheetMAC  = normalizeMAC(getCellValue(row, 2))
      local sheetNAME = trim(getCellValue(row, 3))

      if sheetUUID ~= "" and sheetUUID == uuid then
        if mobile then
          if onDone then onDone(true, sheetNAME) end
          return
        end
        if sheetMAC ~= "" then
          for i = 1, #macs do
            if macs[i] == sheetMAC then
              if onDone then onDone(true, sheetNAME) end
              return
            end
          end
        end
      end
    end

    if onDone then onDone(false, "") end
  end)
end

-- ==========================================================
-- Mobile copy window (só pro botão revogado)
-- ==========================================================
local copyWin = nil

local function destroyCopyWin()
  if copyWin then pcall(function() copyWin:destroy() end) end
  copyWin = nil
end

local function openCopyWindow(text)
  destroyCopyWin()
  copyWin = setupUI([[
UIWindow
  id: copyWin
  size: 330 220
  anchors.centerIn: parent
  text: Copiar UUID/MAC

  Label
    id: hint
    anchors.top: parent.top
    anchors.left: parent.left
    anchors.right: parent.right
    margin-top: 6
    margin-left: 10
    margin-right: 10
    height: 16
    text-align: center
    color: #e6e6e6
    text: Toque e segure no texto para copiar.

  TextEdit
    id: box
    anchors.top: hint.bottom
    anchors.left: parent.left
    anchors.right: parent.right
    anchors.bottom: buttons.top
    margin-top: 6
    margin-left: 10
    margin-right: 10
    margin-bottom: 6
    text-wrap: true
    multiline: true

  Panel
    id: buttons
    height: 34
    anchors.left: parent.left
    anchors.right: parent.right
    anchors.bottom: parent.bottom
    margin-left: 10
    margin-right: 10
    margin-bottom: 10

    Button
      id: close
      anchors.right: parent.right
      anchors.verticalCenter: parent.verticalCenter
      width: 120
      height: 26
      text: Fechar
      font: verdana-9px
      image-source: /images/ui/button_rounded
      image-color: #363636
      color: #e6e6e6
      $hover:
        opacity: 0.90
        color: red
]], g_ui.getRootWidget())

  copyWin.box:setText(tostring(text or ""))
  copyWin.box:focus()
  if copyWin.box.selectAll then pcall(function() copyWin.box:selectAll() end) end
  copyWin.close.onClick = function() copyWin:hide() end
end

local function copyToClipboardPC(text)
  if g_window and type(g_window.setClipboardText) == "function" then
    return pcall(function() g_window.setClipboardText(text) end) == true
  end
  return false
end

local function showUuidMacWindow()
  local uuid = getUUID()
  local macs = getAllMACs()
  local mobile = isMobile()

  local msg
  if mobile then
    msg = "UUID:\n" .. tostring(uuid ~= "" and uuid or "N/A")
    openCopyWindow(msg)
    print(msg)
    return
  end

  msg = "UUID:\n" .. tostring(uuid ~= "" and uuid or "N/A") .. "\n\nMAC(s):\n"
  if #macs > 0 then msg = msg .. joinLines(macs) else msg = msg .. "N/A" end

  if copyToClipboardPC(msg) then
    modules.game_textmessage.displayGameMessage("INFORMACOES COPIADAS, ENVIE NO DISCORD/WHATSAPP")
  else
    modules.game_textmessage.displayGameMessage("NAO CONSEGUI COPIAR (sem clipboard).")
    openCopyWindow(msg)
    print(msg)
  end
end

local revokePanel = nil
local function ensureRevokedButton()
  if revokePanel then return end
  setDefaultTab("Main")
  revokePanel = setupUI([[
Panel
  height: 20
  margin-top: 2

  Button
    id: copyBtn
    anchors.top: parent.top
    anchors.left: parent.left
    anchors.right: parent.right
    height: 18
    text: Copiar UUID/MAC
    font: verdana-9px
    image-source: /images/ui/button_rounded
    image-color: #363636
    color: #e6e6e6
    $hover:
      opacity: 0.90
      color: green
]])
  revokePanel.copyBtn.onClick = function() showUuidMacWindow() end
end

local function destroyRevokedButton()
  if revokePanel then pcall(function() revokePanel:destroy() end) end
  revokePanel = nil
end

-- ==========================================================
-- Loader UI (igual ao seu)
-- ==========================================================
local loaderInterface = setupUI([[
UIWindow
  id: mainPanel
  size: 280 130
  border: 1 black
  anchors.centerIn: parent
  margin-top: -60
  margin-left: -10

  Panel
    id: background
    anchors.top: parent.top
    anchors.left: parent.left
    anchors.right: parent.right
    anchors.bottom: parent.bottom
    background-color: black
    opacity: 0.70

  Panel
    id: topPanel
    anchors.top: parent.top
    anchors.left: parent.left
    anchors.right: parent.right
    size: 120 30
    text-align: center
    !text: tr('DOWNLOAD LNS CUSTOM')
    color: orange
    margin-left: 0
    margin-right: 0
    background-color: black
    $hover:
      image-color: gray

  FlatPanel
    id: panelSpeed
    anchors.top: prev.bottom
    anchors.right: parent.right
    anchors.left: parent.left
    margin-top: 5
    margin-right: 8
    margin-left: 8
    height: 70
    image-color: #363636
    layout: verticalBox

  ProgressBar
    id: bar
    anchors.top: panelSpeed.top
    anchors.left: panelSpeed.left
    anchors.right: panelSpeed.right
    background-color: red
    margin-top: 20
    margin-left: 5
    margin-right: 5
    height: 20
    width: 240
    text-align: center
    font: verdana-9px

  Label
    id: textLabel2
    anchors.top: bar.bottom
    anchors.left: panelSpeed.left
    anchors.right: parent.right
    anchors.bottom: panelSpeed.bottom
    margin-top: 5
    margin-left: 6
    margin-right: 6
    height: 55
    text-align: center
    text-wrap: true
    text-auto-resize: true
    color: #e6e6e6
    font: verdana-11px-rounded

  Label
    id: textLabel
    anchors.top: panelSpeed.top
    anchors.left: panelSpeed.left
    anchors.right: panelSpeed.right
    anchors.bottom: panelSpeed.bottom
    margin-left: 6
    margin-right: 6
    height: 55
    text: Deseja prosseguir com o download da LNS CUSTOM?
    text-align: center
    text-wrap: true
    text-auto-resize: true
    color: #e6e6e6
    font: verdana-11px-rounded

  Button
    id: rejeitar
    anchors.left: panelSpeed.left
    anchors.top: prev.bottom
    height: 20
    width: 133
    text: REJEITAR
    color: red
    font: verdana-9px
    image-source: /images/ui/button_rounded
    image-color: #363636
    margin-top: 4
    opacity: 1.00
    $hover:
      opacity: 0.70

  Button
    id: aceitar
    anchors.left: rejeitar.right
    anchors.top: textLabel.bottom
    height: 20
    width: 132
    text: PROSSEGUIR
    color: green
    font: verdana-9px
    image-source: /images/ui/button_rounded
    image-color: #363636
    margin-top: 4
    opacity: 1.00
    $hover:
      opacity: 0.70
]], g_ui.getRootWidget())

loaderInterface:hide()
loaderInterface.bar:hide()
loaderInterface.textLabel2:hide()

local function ensureDir()
  if g_resources and g_resources.directoryExists and g_resources.directoryExists(BASE_DIR) then return true end
  if g_resources and g_resources.makeDir then pcall(function() g_resources.makeDir(BASE_DIR) end) end
  if g_resources and g_resources.writeFileContents then pcall(function() g_resources.writeFileContents(BASE_DIR .. "/.keep", "ok") end) end
  return (g_resources and g_resources.directoryExists and g_resources.directoryExists(BASE_DIR)) == true
end

-- ==========================================================
-- Files / API
-- ==========================================================
local baseFiles = {
  { url = "https://codeberg.org/lnsscript/lnsCustom/raw/branch/main/lnsLoader", name = "LNS Loader.lua", subdir = "" },
}

local vbotApiLinks = {
  { path = "cavebot",   link = "https://codeberg.org/api/v1/repos/lnsscript/lnsCustom/contents/cavebot?ref=main" },
  { path = "targetbot", link = "https://codeberg.org/api/v1/repos/lnsscript/lnsCustom/contents/targetbot?ref=main" },
  { path = "vBot",      link = "https://codeberg.org/api/v1/repos/lnsscript/lnsCustom/contents/vBot?ref=main" },
}

local vBotFilesAllowed = {
  ["analyzer.lua"] = true,
  ["analyzer.otui"] = true,
  ["cavebot.lua"] = true,
  ["configs.lua"] = true,
  ["depositer_config.lua"] = true,
  ["depositer_config.otui"] = true,
  ["extras.lua"] = true,
  ["extras.otui"] = true,
  ["items.lua"] = true,
  ["new_cavebot_lib.lua"] = true,
  ["supplies.lua"] = true,
  ["supplies.otui"] = true,
  ["vlib.lua"] = true,
}

local vbotToLoad = [[
local configName = modules.game_bot.contentsPanel.config:getCurrentOption().text
local configFiles = g_resources.listDirectoryFiles("/bot/" .. configName .. "/vBot", true, false)
for i, file in ipairs(configFiles) do
  local ext = file:split(".")
  if ext[#ext]:lower() == "ui" or ext[#ext]:lower() == "otui" then
    g_ui.importStyle(file)
  end
end
local function loadScript(name) return dofile("/vBot/" .. name .. ".lua") end
local luaFiles = {"extras","items","vlib","new_cavebot_lib","configs","cavebot","analyzer","supplies","depositer_config"}
for i, file in ipairs(luaFiles) do loadScript(file) end
]]

local function buildVBotQueue(onDone)
  if not json or not json.decode then onDone(nil, "json.decode nao disponivel") return end

  local queue = {}
  local idx = 1

  local function nextCategory()
    local cat = vbotApiLinks[idx]
    if not cat then onDone(queue, nil) return end

    httpGet(cat.link, function(content, err)
      if err or not content then onDone(nil, "Falha API: " .. cat.path) return end

      local ok, data = pcall(function() return json.decode(content) end)
      if not ok or type(data) ~= "table" then onDone(nil, "JSON invalido: " .. cat.path) return end

      for i = 1, #data do
        local item = data[i]
        if item and item.type == "file" and item.download_url then
          if cat.path == "vBot" then
            if vBotFilesAllowed[item.name] then
              queue[#queue + 1] = { url = item.download_url, name = item.name, subdir = cat.path }
            end
          else
            queue[#queue + 1] = { url = item.download_url, name = item.name, subdir = cat.path }
          end
        end
      end

      idx = idx + 1
      schedule(30, nextCategory) -- era 500ms
    end)
  end

  nextCategory()
end

local function ensureSubDir(subdir)
  if not subdir or subdir == "" then return true end
  local p = BASE_DIR .. "/" .. subdir
  if g_resources.directoryExists(p) then return true end
  pcall(function() g_resources.makeDir(p) end)
  return g_resources.directoryExists(p)
end

local function patchVBotContent(_, content)
  if not content then return content end
  content = content:gsub('setDefaultTab%(%s*["\']Tools["\']%s*%)', '')
  return content
end

local function finalizeSuccess()
  if g_resources and g_resources.writeFileContents then
    pcall(function() g_resources.writeFileContents(INSTALLED_TAG, "ok") end)
  end
  modules.game_textmessage.displayGameMessage("Download Concluido! LNS Custom esta pronta para uso.")
  loaderInterface.bar:setPercent(100)
  loaderInterface.bar:setText("CONCLUIDO!")
  reload()
end

-- ==========================================================
-- FAST DOWNLOAD (PARALLEL POOL)
-- ==========================================================
local function downloadAll()
  if not ensureDir() then
    modules.game_textmessage.displayGameMessage("Erro: nao consegui criar a pasta " .. BASE_DIR)
    loaderInterface.aceitar:setEnabled(true)
    loaderInterface.rejeitar:setEnabled(true)
    return
  end

  loaderInterface.bar:show()
  loaderInterface.textLabel:hide()
  loaderInterface.textLabel2:show()
  loaderInterface.textLabel2:setText("Preparando lista...")
  loaderInterface.bar:setPercent(0)
  loaderInterface.bar:setText("BAIXANDO... 0%")

  buildVBotQueue(function(vbotQueue, err)
    if err then
      modules.game_textmessage.displayGameMessage("Erro preparando lista: " .. err)
      loaderInterface.aceitar:setEnabled(true)
      loaderInterface.rejeitar:setEnabled(true)
      return
    end

    local allQueue = {}
    for i = 1, #baseFiles do allQueue[#allQueue+1] = baseFiles[i] end
    for i = 1, #vbotQueue do allQueue[#allQueue+1] = vbotQueue[i] end

    -- parâmetros
    local concurrency = isMobile() and 2 or 4
    local perFileAttempts = isMobile() and 4 or 3
    local roundLimit = 4

    local totalAll = #allQueue
    local round = 0

    local function setProgress(doneNow, totalNow, roundNow)
      local pct = 0
      if totalNow > 0 then
        pct = math.floor((doneNow / totalNow) * 100 + 0.5)
      end
      if pct < 0 then pct = 0 end
      if pct > 100 then pct = 100 end
      loaderInterface.bar:setPercent(pct)
      loaderInterface.bar:setText("BAIXANDO... " .. pct .. "%")
      loaderInterface.textLabel2:setText("Baixando (tentativa " .. roundNow .. "): " .. doneNow .. "/" .. totalNow)
    end

    local function finishFail(fails)
      loaderInterface.textLabel2:setText("Falhou baixar " .. fails .. " arquivo(s). Tente novamente.")
      loaderInterface.bar:setText("FALHOU")
      loaderInterface.aceitar:setEnabled(true)
      loaderInterface.rejeitar:setEnabled(true)
    end

    local function finishOk()
      pcall(function()
        g_resources.writeFileContents(BASE_DIR .. "/_Loader.lua", vbotToLoad)
      end)
      finalizeSuccess()
    end

    local function fetchOneFile(f, cb)
      if not ensureSubDir(f.subdir) then
        return cb(false)
      end

      local attempts = 0
      local baseBackoff = isMobile() and 250 or 160

      local function tryOnce()
        attempts = attempts + 1
        httpGet(f.url, function(content, err2)
          local okContent = (not err2) and content and content ~= ""

          if not okContent then
            if attempts < perFileAttempts then
              local backoff = (attempts * attempts) * baseBackoff
              schedule(backoff, tryOnce)
              return
            end
            cb(false)
            return
          end

          local savePath = BASE_DIR .. (f.subdir ~= "" and ("/" .. f.subdir) or "") .. "/" .. f.name
          content = patchVBotContent(f.name, content)

          local okSave = pcall(function()
            g_resources.writeFileContents(savePath, content)
          end)

          cb(okSave == true)
        end)
      end

      tryOnce()
    end

    local function runRound(queueThisRound)
      round = round + 1

      local totalNow = #queueThisRound
      local doneNow = 0

      if totalNow == 0 then
        return finishOk()
      end

      setProgress(0, totalNow, round)

      local nextIndex = 1
      local active = 0
      local failedList = {}

      local function maybeEnd()
        if doneNow < totalNow then return end

        if #failedList == 0 then
          return finishOk()
        end

        if round >= roundLimit then
          return finishFail(#failedList)
        end

        -- Próxima rodada só com os que falharam
        schedule(isMobile() and 600 or 300, function()
          runRound(failedList)
        end)
      end

      local function pump()
        while active < concurrency and nextIndex <= totalNow do
          local f = queueThisRound[nextIndex]
          nextIndex = nextIndex + 1
          active = active + 1

          fetchOneFile(f, function(okFile)
            active = active - 1

            if not okFile then
              failedList[#failedList+1] = f
            end

            doneNow = doneNow + 1
            setProgress(doneNow, totalNow, round)

            maybeEnd()
            schedule(1, pump)
          end)
        end
      end

      pump()
    end

    loaderInterface.textLabel2:setText("Iniciando download...")
    -- Começa primeira rodada com tudo
    runRound(allQueue)
  end)
end


loaderInterface.aceitar.onClick = function()
  loaderInterface.aceitar:setEnabled(false)
  loaderInterface.rejeitar:setEnabled(false)
  downloadAll()
end

loaderInterface.rejeitar.onClick = function()
  loaderInterface:hide()
end

-- ==========================================================
-- START
-- ==========================================================
schedule(START_DELAY_MS, function()
  checkAuthorization(function(ok, name)
    storage[PANEL_NAME].authorized = ok
    storage[PANEL_NAME].last = now
    storage[PANEL_NAME].name = name or ""

    if not ok then
      modules.game_textmessage.displayGameMessage("[LNS Custom] Acesso nao autorizado (Premium).")
      loaderInterface:hide()
      ensureRevokedButton()
      return
    end

    destroyRevokedButton()

    local n = trim(name or "")
    if n == "" then n = "jogador" end

    modules.game_textmessage.displayGameMessage("[LNS Custom] Acesso autorizado! bem-vindo " .. n .. ", download sendo iniciado...")
    schedule(1500, function()
      if loaderInterface then loaderInterface:show() end
    end)
  end)
end)
